# 优化迭代

## cv_process 优化

输入参数优化： 

cv_process 还缺参数输入参数 logo_info  和  aigc_meta 都是可选字段，
logo_info 的类型为 

LogoInfo
水印相关信息。
名称
类型
必选
描述
备注
add_logo
Boolean
否
是否添加水印。True为添加，False不添加。默认不添加

position
Int
否
水印的位置，取值如下：
0-右下角
1-左下角
2-左上角
3-右上角
默认0

language
Int
否
水印的语言，取值如下：
0-中文（AI生成）
1-英文（Generated by AI）
默认0

opacity
Float
否
水印的不透明度，取值范围0-1，1表示完全不透明，默认1

logo_text_content
String
否
明水印自定义内容

aigc_meta 的类型为 AIGCMeta， 字段为: 
content_producer
String
可选
内容生成服务ID
producer_id
String
可选
内容生成服务商给此图片数据的唯一ID
content_propagator
String
可选
内容传播服务商ID
propagate_id
String
可选
传播服务商给此图片数据的唯一ID

此外，可选的 参数 weight 
默认值：512
取值范围：[256, 768]，

height 参数 
默认值：512
取值范围：[256, 768]，


use_pre_llm 默认为 true 
use_sr 默认为true 


输出格式如下： 

{
    "code": 10000,
    "data": {}
}

其中比较关键的返回值为 data 中 binary_data_base64 和 image_urls 字段。


**round2**

aigc_meta 的请求参数 ，增加一个控制字段，控制添加 add_aigc_meta ，默认为 false ， 

并且为 false 的时候，不展示 

content_producer
String
可选
内容生成服务ID
producer_id
String
可选
内容生成服务商给此图片数据的唯一ID
content_propagator
String
可选
内容传播服务商ID
propagate_id
String
可选
传播服务商给此图片数据的唯一ID
 这些字段 设置。

## 调整插件的逻辑

将 插件提供的功能 该改成 支持 如下的这四类工具

- 同步文生图
- 文生图 
- 图生图 
- 视频生成 
- 动作模仿视频


其中, 同步文生图 就是目前的 cv_process.py 和 cv_process.yaml 

文生图 
支持:

即梦文生图3.0-接口文档: https://www.volcengine.com/docs/85621/1616429


即梦文生图3.1-接口文档: https://www.volcengine.com/docs/85621/1756900

即梦图生图3.0智能参考-接口文档: 

https://www.volcengine.com/docs/85621/1747301 

图生图 

即梦图生图3.0智能参考-接口文档: https://www.volcengine.com/docs/85621/1747301


视频生成: 

即梦AI-视频生成3.0 Pro-接口文档

https://www.volcengine.com/docs/85621/1777001


即梦AI-视频生成3.0 720P-接口文档:

https://www.volcengine.com/docs/85621/1792710

即梦AI-视频生成3.0 1080P-接口文档：

https://www.volcengine.com/docs/85621/1792711

动作模仿-接口文档

https://www.volcengine.com/docs/85621/1798351


## 使用方法 

调用参考: 

同步接口(直接返回结果) Action=CVProcess
调用示例
示例在SDK中的路径：https://github.com/volcengine/volc-sdk-python/blob/main/volcengine/example/visual/cv_process.py# coding:utf-8
from __future__ import print_function

from volcengine.visual.VisualService import VisualService

if __name__ == '__main__':
    visual_service = VisualService()

    # call below method if you don't set ak and sk in $HOME/.volc/config
    visual_service.set_ak('your ak')
    visual_service.set_sk('your sk')
    
    # 请求Body(查看接口文档请求参数-请求示例，将请求参数内容复制到此)
    form = {
        "req_key": "xxx",
        # ...
    }

    resp = visual_service.cv_process(form)
    print(resp)

异步提交任务(返回taskId) Action=CVSubmitTask
调用示例
示例在SDK中的路径：https://github.com/volcengine/volc-sdk-python/blob/main/volcengine/example/visual/cv_submit_task.py# coding:utf-8
from __future__ import print_function

from volcengine import visual
from volcengine.visual.VisualService import VisualService

if __name__ == '__main__':
    visual_service = VisualService()

    # call below method if you don't set ak and sk in $HOME/.volc/config
    visual_service.set_ak('your ak')
    visual_service.set_sk('your sk')
    
    # 请求Body(查看接口文档请求参数-请求示例，将请求参数内容复制到此)
    form = {
        "req_key": "xxx",
        # ...
    }
    resp = visual_service.cv_submit_task( form)
    print(resp)

异步查询任务(返回结果) Action=CVGetResult
调用示例
示例在SDK中的路径：https://github.com/volcengine/volc-sdk-python/blob/main/volcengine/example/visual/cv_get_result.py# coding:utf-8
from __future__ import print_function

from volcengine import visual
from volcengine.visual.VisualService import VisualService

if __name__ == '__main__':
    visual_service = VisualService()

    # call below method if you don't set ak and sk in $HOME/.volc/config
    visual_service.set_ak('your ak')
    visual_service.set_sk('your sk')
    
    # 请求Body(查看接口文档请求参数-请求示例，将请求参数内容复制到此)
    form = {
        "req_key": "xxx",
        "task_id": "xxx"
    }
    resp = visual_service.cv_get_result(form)
    print(resp)

同步转异步提交任务(返回taskId)Action=CVSync2AsyncSubmitTask
调用示例
示例在SDK中的路径：https://github.com/volcengine/volc-sdk-python/blob/main/volcengine/example/visual/cv_sync2async_submit_task.py# coding:utf-8
from __future__ import print_function

from volcengine import visual
from volcengine.visual.VisualService import VisualService

if __name__ == '__main__':
    visual_service = VisualService()

    # call below method if you don't set ak and sk in $HOME/.volc/config
    visual_service.set_ak('your ak')
    visual_service.set_sk('your ak')
    
    # 请求Body(查看接口文档请求参数-请求示例，将请求参数内容复制到此)
    form = {
        "req_key": "xxx",
        # ...

    }
    resp = visual_service.cv_sync2async_submit_task(form)
    print(resp)

同步转异步查询任务(返回结果)Action=CVSync2AsyncGetResult
调用示例
示例在SDK中的路径：https://github.com/volcengine/volc-sdk-python/blob/main/volcengine/example/visual/cv_sync2async_get_result.py# coding:utf-8
from __future__ import print_function

from volcengine import visual
from volcengine.visual.VisualService import VisualService

if __name__ == '__main__':
    visual_service = VisualService()

    # call below method if you don't set ak and sk in $HOME/.volc/config
    visual_service.set_ak('your ak')
    visual_service.set_sk('your ak')
    
    # 请求Body(查看接口文档请求参数-请求示例，将请求参数内容复制到此)
    form = {
        "req_key": "xxx",
        "task_id": "xxx",
        "req_json": "{\"logo_info\":{\"add_logo\":true，\"position\":1, \"language\":1,\"opacity\"：0.5}}"
    }
    resp = visual_service.cv_sync2async_get_result(form)
    print(resp)


## 运行 & 打包

参考官方文档： 

https://docs.dify.ai/plugin-dev-zh/9231-extension-plugin



```sh 
# 运行
python -m main

# 打包
dify plugin package ./xxx
```


## 优化逻辑

根据 API 文档 优化 现存的工具: 

 https://www.volcengine.com/docs/85621/1537648
即梦AI-文生图2.1 


req_key
是
string
服务标识，取固定值: jimeng_high_aes_general_v21_L

仅支持 cv_process, 

其他接口 不支持 cv_process。

即梦AI-文生图2.1 其他参数： 

prompt
是
string
用于生成图像的提示词 ，中英文均可输入
prompt书写规范参考上文描述

seed
可选
int
随机种子，作为确定扩散初始状态的基础，默认-1（随机）。若随机种子为相同正整数且其他参数均一致，则生成图片极大概率效果一致
默认值：-1

width
可选
int
生成图像的宽
默认值：512
取值范围：[256, 768]
宽、高与512差距过大，则出图效果不佳、延迟过长概率显著增加。
超分前建议比例及对应宽高：width*height
1:1：512*512
4:3：512*384
3:4：384*512
3:2：512*341
2:3：341*512
16:9：512*288
9:16：288*512
height
可选
int
生成图像的高
默认值：512
取值范围：[256, 768]
use_pre_llm
可选
bool
开启文本扩写，会针对输入prompt进行扩写优化，如果输入prompt较短建议开启，如果输入prompt较长建议关闭
默认值：true
prompt过短，如长度小于4时，推荐扩写默认打开，保证出图效果更优；
prompt较长，如出图4张，可考虑1次关闭扩写，3次打开扩写，保证出图效果多样性
use_sr
可选
bool
True：文生图+AIGC超分
False：文生图
默认值：true
内置的超分功能，开启后可将上述宽高均乘以2返回，此参数打开后延迟会有增加
如上述宽高均为512和512，此参数关闭出图 512*512 ，此参数打开出图1024 * 1024
return_url
可选
bool
输出是否返回图片链接 （链接有效期为24小时）

logo_info
可选
LogoInfo
水印信息

aigc_meta
可选
AIGCMeta
隐式标识
隐式标识验证方式：
查看【png】或【mp4】格式，人工智能生成合成内容表示服务平台（后续预计增加jpg）
https://www.gcmark.com/web/index.html#/mark/check/image
查看【jpg】格式，使用app11 segment查看aigc元数据内容
如 https://cyber.meme.tips/jpdump/#












req_key
string
必选
算法名称，取固定值为jimeng_t2i_v30


req_key
string
必选
算法名称，取固定值为jimeng_t2i_v31


req_key
string
必选
服务标识
取固定值: jimeng_i2i_v30

## 遇到问题 

由于修改插件已有的逻辑，导致注册失败。 
换个空间就能注册成功了，推测是缓存的问题，这个事情几乎搞好一个上午。
增加尝试逻辑，确认问题在 测试应用中引入了 这个工具, 而工具中之前的action 已经被干掉了。

反复折腾好久，居然是因为这个问题。 还是考虑的不够全面。

An error occurred while parsing the data: b'handshake failed, invalid key'

这个错误原因是，debug 的调试key 是有效期的。出现这个就说明 key 过期了, 更换这个key 即可。

## 完善文生图 

## 完善图生图 
